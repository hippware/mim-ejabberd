{erl_opts, [debug_info,
            {i, ["include"]},
            {d, xml_nif},
            {parse_transform, lager_transform},
            {platform_define, "^R1[6]", latin1_characters},
            {platform_define, "^R1[6]", only_builtin_types}]}. %% Ref: OTP commit b66e75c

{require_otp_vsn, "R?1[678]"}.

%% Make sure the port compiler can find openssl on Mac OS X
{port_env, [
  {"darwin", "CFLAGS",   "$CFLAGS -I/usr/local/opt/openssl/include/ -I/usr/local/include"},
  {"darwin", "CXXFLAGS", "$CXXFLAGS -I/usr/local/opt/openssl/include/ -I/usr/local/include"},
  {"darwin", "LDFLAGS",  "$LDFLAGS -L/usr/local/opt/openssl/lib -L/usr/local/lib"}
]}.

{port_specs, [
  {".*", "priv/lib/tls_drv.so", ["c_src/tls_drv.c"], [{env, [{"LDFLAGS", "$LDFLAGS -lssl"}]}]},
  {".*", "priv/lib/ejabberd_zlib_drv.so", ["c_src/ejabberd_zlib_drv.c"], [{env, [{"LDFLAGS", "$LDFLAGS -lz"}]}]}
]}.

{asn1_opts, [{outdir, "src"}, noobj]}.

{provider_hooks, [
  {pre, [
    {compile, {pc,   compile}},
    {compile, {asn1, compile}},
    {clean,   {pc,   clean}},
    {clean,   {asn1, clean}}
  ]}
]}.

{deps, [
  {redo,            "2.0.1"},
  {cowboy,          "1.0.4"},
  {folsom,          "0.8.3"},
  {idna,            "2.0.0"},
  {p1_utils,        "1.0.4"},
  {cache_tab,       "1.0.2"},
  {stringprep,      "1.0.3"},
  {base16,          "1.0.0"},
  {setup,           "1.7.0"},
  {lager,           "3.2.1"},
  {cuesport,        {github, "esl/cuesport",             {branch, "master"}}},
  {exml,            {github, "esl/exml",                 {tag, "2.2.0"}}},
  {exometer_core,   {github, "Feuerlabs/exometer_core",  {branch, "master"}}},
  {exometer,        {github, "Feuerlabs/exometer",       {branch, "master"}}},
  {mochijson2,      {github, "bjnortier/mochijson2",     {branch, "master"}}},
  {alarms,          {github, "hippware/alarms",          {tag, "0.1.2"}}},
  {fusco,           {github, "esl/fusco",                {branch, "master"}}},
  {pa,              {github, "lavrin/pa",                {branch, "master"}}},
  {usec,            {github, "esl/usec",                 {branch, "master"}}},
  {riak_pb,         {github, "basho/riak_pb",            {tag, "2.1.4.0"}}},
  {riakc,           {github, "basho/riak-erlang-client", {tag, "2.1.2"}}},

  %% The Cassandra related dependencies are unnecessary for our purposes.
  %% Skip them.
  %% {poolboy,         "1.5.1"},
  %% {seestar,         {github, "iamaleksey/seestar",       {branch, "master"}}},

  %% Runtime dependencies that can be skipped.
  %% {recon,           "2.3.1"},
  %% {lager_syslog,    {github, "basho/lager_syslog",       {tag, "3.0.1"}}},

  %% Test dependencies
  {edown,           "0.8.1"},
  {meck,            "0.8.4"},
  {proper,          {github, "manopapad/proper",           {tag, "v1.2"}}},
  {hamcrest,        {github, "hyperthunk/hamcrest-erlang", {branch, "master"}}}

  %% CI related dependencies that can be skipped
  %% {ecoveralls,      {github, "nifoc/ecoveralls",           {branch, "master"}}},
  %% {mustache,        {github, "mojombo/mustache.erl",       {branch, "master"}}}
 ]}.

{overrides, [
  %% Setup has a post_hook that attempts to generate an escript
  %% the hook fails and we don't need the escript so blank out the hook
  {override, setup, [
    {post_hooks, []}
  ]},

  {override, hamcrest, [
    {plugins, []},
    {pre_hooks, [
      {compile, "./rebar compile skip_deps=true deps_dir=.."}
    ]}
  ]},

  %% Some dependencies use rebar 2 plugins causing a warning on every compile
  %% Since they don't work anyway, we can just zero-out the plugin list and
  %% call rebar 2 to do the actual build.
  {override, riak_pb, [
    {plugins, []},
    {pre_hooks, [
      {compile, "./rebar compile skip_deps=true deps_dir=.."}
    ]}
  ]},

  %% stringprep and exml have ports/nifs that require the port compiler.
  %% In rebar3 it is a plugin, so we need to hook it into the build pipeline.
  {override, stringprep, [
    {provider_hooks, [{pre, [{compile, {pc, compile}}, {clean, {pc, clean}}]}]}
  ]},

  {override, exml, [
    {provider_hooks, [{pre, [{compile, {pc, compile}}, {clean, {pc, clean}}]}]}
  ]}
]}.

{plugins, [
  {pc, "1.2.0"},
  {rebar3_asn1_compiler, {git, "https://github.com/hippware/rebar3_asn1_compiler.git", {branch, "master"}}},
  {rebar_tidy_deps, {git, "https://github.com/kellymclaughlin/rebar3-tidy-deps-plugin.git", {tag, "0.0.2"}}}
]}.
